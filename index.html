<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login Ujian PKBM</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card shadow">
          <div class="card-header text-center">
            <h3>Login Ujian PKBM Kuntum Mekar</h3>
          </div>
          <div class="card-body">
            <form id="login-form">
              <div class="mb-3">
                <label for="nama" class="form-label">Nama Siswa</label>
                <input type="text" class="form-control" id="nama" required />
              </div>
              <div class="mb-3">
                <label for="nisn" class="form-label">NISN</label>
                <input type="text" class="form-control" id="nisn" required />
              </div>
              <div class="mb-3">
                <label for="kelas" class="form-label">Kelas</label>
                <select id="kelas" class="form-select" required>
                  <option value="">-- Pilih Kelas --</option>
                  <option value="Paket A Kelas VI">Paket A Kelas VI</option>
                  <option value="Paket B Kelas IX">Paket B Kelas IX</option>
                  <option value="Paket C Kelas XII">Paket C Kelas XII</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary w-100">Login</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS & dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- JSONP Login Script -->
  <script>
    function loginViaJSONP(nama, nisn, kelas) {
      return new Promise(resolve => {
        const callbackName = 'cb_' + Date.now();
        window[callbackName] = function(res) {
          resolve(res);
          delete window[callbackName];
        };
        const base = 'https://script.google.com/macros/s/AKfycbweUxww34uk0pqPE-Gk_xaebgvxRNRCFicXy7I22gYTlt2xFi1uwrv1iK0FhTDEaw17/exec';
        const params = [
          'action=login',
          'nama='   + encodeURIComponent(nama),
          'nisn='   + encodeURIComponent(nisn),
          'kelas='  + encodeURIComponent(kelas),
          'callback='+ callbackName
        ].join('&');
        const s = document.createElement('script');
        s.src = `${base}?${params}`;
        document.body.appendChild(s);
      });
    }

    document.getElementById('login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const nama  = document.getElementById('nama').value.trim();
      const nisn  = document.getElementById('nisn').value.trim();
      const kelas = document.getElementById('kelas').value;
      try {
        const result = await loginViaJSONP(nama, nisn, kelas);
        if (result.success) {
          sessionStorage.setItem('user', JSON.stringify({ nama, nisn, kelas }));
          window.location.href = 'mapel.html';
        } else {
          alert(result.message);
        }
      } catch (err) {
        console.error(err);
        alert('Terjadi kesalahan jaringan. Silakan coba lagi.');
      }
    });
  </script>
</body>
</html>